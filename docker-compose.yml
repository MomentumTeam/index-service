version: "2.1"
services:
  rabbitmq:
    image: 'drivehub.azurecr.io/meateam/rabbitmq:latest'
    hostname: rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://rabbitmq:15672" ]
      interval: 10s
      timeout: 10s
      retries: 15

  managerService:
    image: manager-spring-boot
    build: ./manager-service
    environment:
      - INDUX_RABBIT_URL=${INDUX_RABBIT_URL}
      - INDUX_EXCHANGE_NAME=${INDUX_EXCHANGE_NAME}
      - INDUX_EVENTS_QUEUE_NAME=${INDUX_EVENTS_QUEUE_NAME}
      - INDUX_EVENTS_ROUTING_KEY=${INDUX_EVENTS_ROUTING_KEY}
      - INDUX_DELETE_QUEUE_NAME=${INDUX_DELETE_QUEUE_NAME}
      - INDUX_DELETE_ROUTING_KEY=${INDUX_DELETE_ROUTING_KEY}
      - INDUX_DRIVE_SERVICE_QUEUE_NAME=${INDUX_DRIVE_SERVICE_QUEUE_NAME}
      - INDUX_DRIVE_SERVICE_ROUTING_KEY=${INDUX_DRIVE_SERVICE_ROUTING_KEY}
      - INDUX_ERROR_QUEUE_NAME=${INDUX_ERROR_QUEUE_NAME}
      - INDUX_ERROR_ROUTING_KEY=${INDUX_ERROR_ROUTING_KEY}
#    volumes:
#       - ${INDUX_MAVEN_SETTINGS_FOLDER}:/root/.m2   # comment this line if you do not want to use you local maven settings or if you do not have a local maven installed
    depends_on:
      - rabbitmq

  driveService:
    image: drive-spring-boot
    build: ./drive-service
    environment:
      - INDUX_RABBIT_URL=${INDUX_RABBIT_URL}
      - INDUX_EXCHANGE_NAME=${INDUX_EXCHANGE_NAME}
      - INDUX_EVENTS_QUEUE_NAME=${INDUX_EVENTS_QUEUE_NAME}
      - INDUX_EVENTS_ROUTING_KEY=${INDUX_EVENTS_ROUTING_KEY}
      - INDUX_DELETE_QUEUE_NAME=${INDUX_DELETE_QUEUE_NAME}
      - INDUX_DELETE_ROUTING_KEY=${INDUX_DELETE_ROUTING_KEY}
      - INDUX_DRIVE_SERVICE_QUEUE_NAME=${INDUX_DRIVE_SERVICE_QUEUE_NAME}
      - INDUX_DRIVE_SERVICE_ROUTING_KEY=${INDUX_DRIVE_SERVICE_ROUTING_KEY}
      - INDUX_ERROR_QUEUE_NAME=${INDUX_ERROR_QUEUE_NAME}
      - INDUX_ERROR_ROUTING_KEY=${INDUX_ERROR_ROUTING_KEY}
      - INDUX_PARSING_SERVICE_QUEUE_NAME=${INDUX_PARSING_SERVICE_QUEUE_NAME}
      - INDUX_PARSING_SERVICE_ROUTING_KEY=${INDUX_PARSING_SERVICE_ROUTING_KEY}
      - INDUX_ELASTIC_SERVICE_QUEUE_NAME=${INDUX_ELASTIC_SERVICE_QUEUE_NAME}
      - INDUX_ELASTIC_SERVICE_ROUTING_KEY=${INDUX_ELASTIC_SERVICE_ROUTING_KEY}
      - INDUX_DRIVE_URL=${INDUX_DRIVE_URL}
      - INDUX_DOWNLOAD_SERVICE_PORT=${INDUX_DOWNLOAD_SERVICE_PORT}
      - INDUX_FILE_SERVICE_PORT=${INDUX_FILE_SERVICE_PORT}
      - INDUX_USER_SERVICE_PORT=${INDUX_USER_SERVICE_PORT}
      - INDUX_PERMISSION_SERVICE_PORT=${INDUX_PERMISSION_SERVICE_PORT}
      - INDUX_FOLDER_TYPE=${INDUX_FOLDER_TYPE}
#    volumes:
#       - ${INDUX_MAVEN_SETTINGS_FOLDER}:/root/.m2   # comment this line if you do not want to use you local maven settings or if you do not have a local maven installed
    depends_on:
      - rabbitmq

  deleteService:
    image: delete-spring-boot
    build: ./delete-service
    environment:
      - INDUX_RABBIT_URL=${INDUX_RABBIT_URL}
      - INDUX_EXCHANGE_NAME=${INDUX_EXCHANGE_NAME}
      - INDUX_EVENTS_QUEUE_NAME=${INDUX_EVENTS_QUEUE_NAME}
      - INDUX_EVENTS_ROUTING_KEY=${INDUX_EVENTS_ROUTING_KEY}
      - INDUX_DELETE_QUEUE_NAME=${INDUX_DELETE_QUEUE_NAME}
      - INDUX_DELETE_ROUTING_KEY=${INDUX_DELETE_ROUTING_KEY}
      - INDUX_DRIVE_SERVICE_QUEUE_NAME=${INDUX_DRIVE_SERVICE_QUEUE_NAME}
      - INDUX_DRIVE_SERVICE_ROUTING_KEY=${INDUX_DRIVE_SERVICE_ROUTING_KEY}
      - INDUX_ERROR_QUEUE_NAME=${INDUX_ERROR_QUEUE_NAME}
      - INDUX_ERROR_ROUTING_KEY=${INDUX_ERROR_ROUTING_KEY}
      - INDUX_ELASTIC_HOST=${INDUX_ELASTIC_HOST}
      - INDUX_ELASTIC_PORT=${INDUX_ELASTIC_PORT}
      - INDUX_ELASTIC_PROTOCOL=${INDUX_ELASTIC_PROTOCOL}
#    volumes:
#       - ${INDUX_MAVEN_SETTINGS_FOLDER}:/root/.m2   # comment this line if you do not want to use you local maven settings or if you do not have a local maven installed
    depends_on:
      - rabbitmq

  elasticService:
    image: elastic-spring-boot
    build: ./elastic-service
    environment:
      - INDUX_RABBIT_URL=${INDUX_RABBIT_URL}
      - INDUX_EXCHANGE_NAME=${INDUX_EXCHANGE_NAME}
      - INDUX_ELASTIC_SERVICE_QUEUE_NAME=${INDUX_ELASTIC_SERVICE_QUEUE_NAME}
      - INDUX_ELASTIC_SERVICE_ROUTING_KEY=${INDUX_ELASTIC_SERVICE_ROUTING_KEY}
      - INDUX_ERROR_QUEUE_NAME=${INDUX_ERROR_QUEUE_NAME}
      - INDUX_ERROR_ROUTING_KEY=${INDUX_ERROR_ROUTING_KEY}
      - INDUX_ELASTIC_HOST=${INDUX_ELASTIC_HOST}
      - INDUX_ELASTIC_PORT=${INDUX_ELASTIC_PORT}
      - INDUX_ELASTIC_PROTOCOL=${INDUX_ELASTIC_PROTOCOL}
#    volumes:
#       - ${INDUX_MAVEN_SETTINGS_FOLDER}:/root/.m2   # comment this line if you do not want to use you local maven settings or if you do not have a local maven installed
    depends_on:
      - rabbitmq

#  errorService:
#    image: error-spring-boot
#    build: ./error-service
#    environment:
#      - INDUX_RABBIT_URL=${INDUX_RABBIT_URL}
#      - INDUX_EXCHANGE_NAME=${INDUX_EXCHANGE_NAME}
#      - INDUX_DELETE_QUEUE_NAME=${INDUX_DELETE_QUEUE_NAME}
#      - INDUX_DELETE_ROUTING_KEY=${INDUX_DELETE_ROUTING_KEY}
#      - INDUX_ERROR_QUEUE_NAME=${INDUX_ERROR_QUEUE_NAME}
#      - INDUX_ERROR_ROUTING_KEY=${INDUX_ERROR_ROUTING_KEY}
#      - INDUX_DRIVE_URL=${INDUX_DRIVE_URL}
#      - INDUX_DOWNLOAD_SERVICE_PORT=${INDUX_DOWNLOAD_SERVICE_PORT}
#      - INDUX_DOWNLOAD_FOLDER_PATH=${INDUX_DOWNLOAD_FOLDER_PATH}
#      - INDUX_CHUNK_SIZE=${INDUX_CHUNK_SIZE}
#      - INDUX_PRE_SUFF_SIZE=${INDUX_PRE_SUFF_SIZE}
#
#    volumes:
#      - ${INDUX_MAVEN_SETTINGS_FOLDER}:/root/.m2   # comment this line if you do not want to use you local maven settings or if you do not have a local maven installed
#    depends_on:
#      - rabbitmq


  parsingService:
    image: parsing-spring-boot
    build: ./parsing-service
    environment:
      - INDUX_RABBIT_URL=${INDUX_RABBIT_URL}
      - INDUX_EXCHANGE_NAME=${INDUX_EXCHANGE_NAME}
      - INDUX_PARSING_SERVICE_QUEUE_NAME=${INDUX_PARSING_SERVICE_QUEUE_NAME}
      - INDUX_PARSING_SERVICE_ROUTING_KEY=${INDUX_PARSING_SERVICE_ROUTING_KEY}
      - INDUX_ELASTIC_SERVICE_QUEUE_NAME=${INDUX_ELASTIC_SERVICE_QUEUE_NAME}
      - INDUX_ELASTIC_SERVICE_ROUTING_KEY=${INDUX_ELASTIC_SERVICE_ROUTING_KEY}
      - INDUX_ERROR_QUEUE_NAME=${INDUX_ERROR_QUEUE_NAME}
      - INDUX_ERROR_ROUTING_KEY=${INDUX_ERROR_ROUTING_KEY}
      - INDUX_DRIVE_URL=${INDUX_DRIVE_URL}
      - INDUX_DOWNLOAD_SERVICE_PORT=${INDUX_DOWNLOAD_SERVICE_PORT}
      - INDUX_FILE_SERVICE_PORT=${INDUX_FILE_SERVICE_PORT}
      - INDUX_USER_SERVICE_PORT=${INDUX_USER_SERVICE_PORT}
#      - INDUX_DOWNLOAD_FOLDER_PATH=${INDUX_DOWNLOAD_FOLDER_PATH}
      - INDUX_CHUNK_SIZE=${INDUX_CHUNK_SIZE}
      - INDUX_SUFF_PRE_SIZE=${INDUX_SUFF_PRE_SIZE}
#    volumes:
      # - ${INDUX_MAVEN_SETTINGS_FOLDER}:/root/.m2   # comment this line if you do not want to use you local maven settings or if you do not have a local maven installed
    depends_on:
      - rabbitmq

  search:
    build: ./search-service
    environment:
      - INDUX_DRIVE_URL=${INDUX_DRIVE_URL}
      - INDUX_FILE_SERVICE_PORT=${INDUX_FILE_SERVICE_PORT}
      - INDUX_PERMISSION_SERVICE_PORT=${INDUX_PERMISSION_SERVICE_PORT}
      - INDUX_ELASTIC_HOST=${INDUX_ELASTIC_HOST}
      - INDUX_ELASTIC_PORT=${INDUX_ELASTIC_PORT}
      - INDUX_ELASTIC_PROTOCOL=${INDUX_ELASTIC_PROTOCOL}
      - INDUX_SEARCH_URL=${INDUX_SEARCH_URL}
      - INDUX_OLDEST_YEAR=${INDUX_OLDEST_YEAR}
      - INDUX_OLDEST_MONTH=${INDUX_OLDEST_MONTH}
      - INDUX_OLDEST_DAY=${INDUX_OLDEST_DAY}
    ports:
      - 8005:8005
    restart: on-failure